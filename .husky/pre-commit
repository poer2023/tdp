# ============================================================================
# Pre-commit Hook: Prisma Schema æ£€æŸ¥
# ============================================================================
# å½“ schema.prisma è¢«ä¿®æ”¹æ—¶,è‡ªåŠ¨æ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”çš„è¿ç§»æ–‡ä»¶
# é˜²æ­¢ä½¿ç”¨ 'db push' å¯¼è‡´çš„è¿ç§»å†å²ä¸¢å¤±
# ============================================================================

# è·å–è¢«ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨
CHANGED_FILES=$(git diff --cached --name-only)

# æ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº† schema.prisma
if echo "$CHANGED_FILES" | grep -q "prisma/schema.prisma"; then
  echo "ğŸ” æ£€æµ‹åˆ° Prisma Schema å˜æ›´..."

  # æ£€æŸ¥æ˜¯å¦åŒæ—¶æœ‰æ–°çš„è¿ç§»æ–‡ä»¶
  NEW_MIGRATIONS=$(git diff --cached --name-only | grep "prisma/migrations/" || echo "")

  if [ -z "$NEW_MIGRATIONS" ]; then
    echo ""
    echo "âš ï¸  è­¦å‘Š: æ£€æµ‹åˆ° schema.prisma å˜æ›´,ä½†æ²¡æœ‰æ–°çš„è¿ç§»æ–‡ä»¶!"
    echo ""
    echo "âŒ ä¸è¦ä½¿ç”¨ 'prisma db push' - å®ƒä¸ä¼šç”Ÿæˆè¿ç§»æ–‡ä»¶"
    echo "âœ… è¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºè¿ç§»:"
    echo ""
    echo "   pnpm exec prisma migrate dev --name describe_your_change"
    echo ""
    echo "ğŸ’¡ æç¤º:"
    echo "   1. 'prisma migrate dev' ä¼šç”Ÿæˆè¿ç§»æ–‡ä»¶å¹¶åº”ç”¨åˆ°å¼€å‘æ•°æ®åº“"
    echo "   2. è¿ç§»æ–‡ä»¶ä¼šè¢«è‡ªåŠ¨æ·»åŠ åˆ° Git staging area"
    echo "   3. æäº¤æ—¶ä¼šåŒ…å« schema.prisma å’Œå¯¹åº”çš„è¿ç§»æ–‡ä»¶"
    echo ""
    echo "ğŸ“š å‚è€ƒæ–‡æ¡£:"
    echo "   https://www.prisma.io/docs/orm/prisma-migrate/workflows/development-and-production"
    echo ""
    echo "â­ï¸  å¦‚æœä½ å·²ç»åˆ›å»ºäº†è¿ç§»,è¯·å°†å…¶æ·»åŠ åˆ° staging area:"
    echo "   git add prisma/migrations/"
    echo ""
    echo "ğŸš« å¦‚æœä½ ç¡®å®éœ€è¦è·³è¿‡æ­¤æ£€æŸ¥ (ä¸æ¨è),ä½¿ç”¨:"
    echo "   git commit --no-verify"
    echo ""

    # é€€å‡ºçŠ¶æ€ä¸º 1,é˜»æ­¢æäº¤
    exit 1
  else
    echo "âœ… æ£€æµ‹åˆ°æ–°çš„è¿ç§»æ–‡ä»¶,å…è®¸æäº¤:"
    echo "$NEW_MIGRATIONS"
    echo ""
  fi
fi

# æ‰€æœ‰æ£€æŸ¥é€šè¿‡,å…è®¸æäº¤
exit 0
