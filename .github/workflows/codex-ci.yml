name: codex-ci

on:
  workflow_run:
    workflows:
      - "E2E Full Suite (Non-blocking)"
      - "build-and-test"
    types:
      - completed

permissions:
  actions: read
  contents: write
  pull-requests: write

jobs:
  codex:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: tdp_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - "5432:5432"
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/tdp_test?schema=public
      NODE_ENV: test

    steps:
      - name: Checkout failing commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        run: npm ci

      - name: Prepare database
        run: |
          npx prisma migrate deploy
          if [ -f prisma/seed.ts ] || [ -f prisma/seed.js ]; then npx prisma db seed || true; fi

      - name: Download artifacts from failed run
        uses: actions/download-artifact@v4
        with:
          pattern: "*-coverage-report|*-test-results|playwright-*|ci-*"
          merge-multiple: true
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Merge logs for Codex
        run: |
          mkdir -p ci
          # Try to find any log files from various artifact patterns
          find . -type f \( -name "*.log" -o -name "*test*.xml" -o -name "*results*.json" \) 2>/dev/null | head -20 > ci/found-files.txt || true
          if [ -s ci/found-files.txt ]; then
            cat ci/found-files.txt | xargs cat > ci/last-failure.log 2>/dev/null || echo "Failed to merge logs" > ci/last-failure.log
          else
            echo "No test artifacts or logs found from failed workflow run" > ci/last-failure.log
          fi
          echo "=== Found Files ===" && cat ci/found-files.txt || true
          echo "=== Merged Logs (first 100 lines) ===" && head -n 100 ci/last-failure.log || true

      - name: Setup Codex CLI
        run: |
          npm i -g @openai/codex
          codex --version
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Autofix with Codex
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          codex --model gpt-4 \
            "Read ci/last-failure.log; reproduce locally per AGENTS.md; fix only what's needed for failing specs; run npm run lint && npm run type-check && npx playwright test --reporter=line; keep changes minimal and explain in PR body."

      - name: Verify after edits
        run: |
          npm run lint
          npm run type-check
          npx playwright install --with-deps
          npx playwright test --reporter=line
          npm run build

      - name: Open PR if changes exist
        uses: peter-evans/create-pull-request@v6
        with:
          branch: codex/fix-${{ github.run_id }}
          title: "Autofix failing E2E via Codex"
          commit-message: "fix(e2e): autofix by Codex"
          body: |
            Autofix by Codex.
            Based on logs from run ${{ github.event.workflow_run.id }}.
            See AGENTS.md and ci/last-failure.log for context.
          author: codex-bot <codex-bot@users.noreply.github.com>
