name: Prettier Auto Format

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  format:
    name: Run Prettier and auto-commit
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run Prettier (write)
        shell: bash
        run: |
          set -euo pipefail

          # Build pattern list
          printf "%s\n" \
            "docs/**/*.md" \
            "README.md" \
            "USER_ACTION_REQUIRED.md" \
            "codex.md" \
            "部署规范.md" \
            "e2e/**/*.ts" \
            "e2e/**/*.tsx" \
            ".github/workflows/**/*.yml" \
            ".github/workflows/**/*.yaml" \
            "docker-compose.yml" > patterns.txt

          echo "Formatting patterns:"
          cat patterns.txt

          # Expand patterns to concrete files using git pathspec globs
          : > files.txt
          while IFS= read -r pat; do
            git ls-files -z -- ":(glob)${pat}" >> files.bin || true
          done < patterns.txt
          if [ -f files.bin ]; then
            tr '\0' '\n' < files.bin | sort -u > files.txt
            rm -f files.bin
          fi

          echo "Matched files:" || true
          sed 's/^/  - /' files.txt || true

          # If nothing matched, exit gracefully
          if [ ! -s files.txt ]; then
            echo "No files matched. Skipping Prettier."
            exit 0
          fi

          xargs -a files.txt -r npx prettier --write

      - name: Commit and push changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore(prettier): auto-format docs, workflows, e2e, docker-compose"
            git push
          else
            echo "No changes to commit."
          fi
