name: Schema Guard

# å½“ Prisma Schema æ–‡ä»¶å˜æ›´æ—¶è‡ªåŠ¨è§¦å‘æ£€æŸ¥
# ç¡®ä¿æ‰€æœ‰ Schema å˜æ›´éƒ½æœ‰å¯¹åº”çš„è¿ç§»æ–‡ä»¶
on:
  pull_request:
    paths:
      - "prisma/schema.prisma"
    branches:
      - main
      - develop

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  check-missing-migrations:
    name: Detect Schema Changes Without Migrations
    runs-on: ubuntu-latest

    # ä½¿ç”¨ PostgreSQL æœåŠ¡ä½œä¸º shadow database
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: shadow_db
        options: >-
          --health-cmd pg_isready
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    env:
      # Shadow database ç”¨äº Prisma æ¯”è¾ƒ Schema å·®å¼‚
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/shadow_db?schema=public

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥ä¾¿å¯¹æ¯”

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.16.1

      - name: Cache Prisma binaries
        uses: actions/cache@v4
        with:
          path: |
            node_modules/.prisma
            ~/.cache/prisma
          key: ${{ runner.os }}-prisma-${{ hashFiles('prisma/schema.prisma') }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-prisma-${{ hashFiles('prisma/schema.prisma') }}-
            ${{ runner.os }}-prisma-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for missing migrations (Official Prisma Method)
        id: migration_check
        run: |
          echo "ğŸ” Checking for schema changes without corresponding migrations..."

          # Prisma å®˜æ–¹æ¨èæ–¹æ³•: ä½¿ç”¨ migrate diff æ£€æµ‹ Schema æ¼‚ç§»
          # å¦‚æœ schema.prisma ä¸ç°æœ‰è¿ç§»ä¸ä¸€è‡´,æ­¤å‘½ä»¤è¿”å›éé›¶é€€å‡ºç 
          if pnpm exec prisma migrate diff \
            --exit-code \
            --from-migrations ./prisma/migrations \
            --to-schema-datamodel ./prisma/schema.prisma \
            --shadow-database-url "$DATABASE_URL"; then

            echo "âœ… Schema ä¸è¿ç§»æ–‡ä»¶ä¸€è‡´,æ— éœ€é¢å¤–è¿ç§»"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ£€æµ‹åˆ° Schema å˜æ›´ä½†ç¼ºå°‘è¿ç§»æ–‡ä»¶!"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Report schema drift (if detected)
        if: failure()
        run: |
          echo "::error::Schema å˜æ›´æ£€æµ‹åˆ°,ä½†æ²¡æœ‰å¯¹åº”çš„è¿ç§»æ–‡ä»¶"
          echo "::error::è¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºè¿ç§»:"
          echo "::error::  npx prisma migrate dev --name describe_your_change"
          echo ""
          echo "âš ï¸ é‡è¦æç¤º:"
          echo "1. ä¸è¦ä½¿ç”¨ 'prisma db push' - å®ƒä¸ä¼šç”Ÿæˆè¿ç§»æ–‡ä»¶"
          echo "2. ä½¿ç”¨ 'prisma migrate dev' ç”Ÿæˆè¿ç§»å¹¶è‡ªåŠ¨åº”ç”¨åˆ°å¼€å‘æ•°æ®åº“"
          echo "3. æäº¤è¿ç§»æ–‡ä»¶åˆ° Git ä»“åº“"
          echo ""
          echo "å‚è€ƒæ–‡æ¡£: https://www.prisma.io/docs/orm/prisma-migrate/workflows/development-and-production"
          exit 1

      - name: Validate Prisma schema syntax
        run: pnpm exec prisma validate

      - name: Check Prisma version consistency
        run: |
          PRISMA_CLI=$(pnpm list prisma --depth=0 | grep prisma@ | sed 's/.*@//' | tr -d ' ')
          PRISMA_CLIENT=$(pnpm list @prisma/client --depth=0 | grep @prisma/client@ | sed 's/.*@//' | tr -d ' ')

          echo "Prisma CLI version: $PRISMA_CLI"
          echo "Prisma Client version: $PRISMA_CLIENT"

          if [ "$PRISMA_CLI" != "$PRISMA_CLIENT" ]; then
            echo "::error::Prisma ç‰ˆæœ¬ä¸ä¸€è‡´!"
            echo "::error::CLI: $PRISMA_CLI, Client: $PRISMA_CLIENT"
            echo "::error::è¯·ç¡®ä¿ package.json ä¸­ä¸¤è€…ç‰ˆæœ¬ä¸€è‡´"
            exit 1
          fi

          echo "âœ… Prisma ç‰ˆæœ¬ä¸€è‡´: $PRISMA_CLI"

  validate-migration-files:
    name: Validate Migration Files
    runs-on: ubuntu-latest
    needs: check-missing-migrations

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check migration file naming convention
        run: |
          echo "ğŸ” Validating migration file naming conventions..."
          INVALID_MIGRATIONS=""

          for dir in prisma/migrations/*/; do
            dirname=$(basename "$dir")
            # Skip _current if exists
            if [ "$dirname" = "_current" ]; then
              continue
            fi

            # Check format: YYYYMMDDHHMMSS_description
            if ! echo "$dirname" | grep -qE '^[0-9]{14}_[a-z0-9_]+$'; then
              INVALID_MIGRATIONS="$INVALID_MIGRATIONS\n  - $dirname"
            fi

            # Verify migration.sql exists
            if [ ! -f "${dir}migration.sql" ]; then
              echo "âŒ Missing migration.sql in $dirname"
              exit 1
            fi
          done

          if [ -n "$INVALID_MIGRATIONS" ]; then
            echo "âš ï¸ Migration folders with non-standard naming:"
            echo -e "$INVALID_MIGRATIONS"
            echo "Expected format: YYYYMMDDHHMMSS_description (e.g., 20251201120000_add_users)"
          else
            echo "âœ… All migration files follow naming conventions"
          fi

      - name: Check for destructive operations
        run: |
          echo "ğŸ” Checking for potentially destructive SQL operations..."
          WARNINGS=""

          for file in prisma/migrations/*/migration.sql; do
            if [ -f "$file" ]; then
              # Check for DROP operations
              if grep -iE 'DROP\s+(TABLE|COLUMN|INDEX|CONSTRAINT)' "$file" > /dev/null 2>&1; then
                WARNINGS="$WARNINGS\n  âš ï¸  $file contains DROP operations"
              fi

              # Check for TRUNCATE
              if grep -iE 'TRUNCATE' "$file" > /dev/null 2>&1; then
                WARNINGS="$WARNINGS\n  âš ï¸  $file contains TRUNCATE operations"
              fi

              # Check for data modification
              if grep -iE 'DELETE\s+FROM|UPDATE\s+.*\s+SET' "$file" > /dev/null 2>&1; then
                WARNINGS="$WARNINGS\n  âš ï¸  $file contains data modification operations"
              fi
            fi
          done

          if [ -n "$WARNINGS" ]; then
            echo "âš ï¸ Destructive operations detected (review required):"
            echo -e "$WARNINGS"
            echo ""
            echo "::warning::Review these migrations carefully before deploying to production"
          else
            echo "âœ… No destructive operations detected in migrations"
          fi

  analyze-migration-changes:
    name: Analyze Migration Changes
    runs-on: ubuntu-latest
    needs: validate-migration-files
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect new migration files
        id: detect_migrations
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„è¿ç§»æ–‡ä»¶
          NEW_MIGRATIONS=$(git diff --name-only origin/main...HEAD | grep 'prisma/migrations/' || echo "")

          if [ -n "$NEW_MIGRATIONS" ]; then
            echo "âœ… æ£€æµ‹åˆ°æ–°çš„è¿ç§»æ–‡ä»¶:"
            echo "$NEW_MIGRATIONS"
            echo "has_migrations=true" >> $GITHUB_OUTPUT
            echo "migration_files<<EOF" >> $GITHUB_OUTPUT
            echo "$NEW_MIGRATIONS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ æœ¬æ¬¡ PR æ²¡æœ‰æ–°çš„è¿ç§»æ–‡ä»¶"
            echo "has_migrations=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with migration info
        if: steps.detect_migrations.outputs.has_migrations == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const migrations = `${{ steps.detect_migrations.outputs.migration_files }}`;
            const comment = `## ğŸ”„ Database Migration Detected

            This PR includes database schema changes:

            \`\`\`
            ${migrations}
            \`\`\`

            ### âš ï¸ Deployment Checklist
            - [ ] è¿ç§»å·²åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒæµ‹è¯•
            - [ ] è¿ç§»åŒ…å«å›æ»šè®¡åˆ’ï¼ˆå¦‚æœéœ€è¦ï¼‰
            - [ ] éƒ¨ç½²å‰å·²é€šçŸ¥å›¢é˜Ÿæˆå‘˜
            - [ ] ç¡®è®¤ç”Ÿäº§æ•°æ®åº“æœ‰å®Œæ•´å¤‡ä»½

            ### ğŸ“š ç›¸å…³æ–‡æ¡£
            - [Prisma Migration Guide](https://www.prisma.io/docs/orm/prisma-migrate)
            - [Production Deployment](docs/PRODUCTION_DEPLOYMENT_GUIDE.md)
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
