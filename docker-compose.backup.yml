version: "3.8"

################################################################################
# PostgreSQL è‡ªåŠ¨åŒ–å¤‡ä»½é…ç½®
#
# åŠŸèƒ½:
#   - æ¯æ—¥è‡ªåŠ¨å¤‡ä»½æ•°æ®åº“
#   - å¯é…ç½®çš„å¤‡ä»½ä¿ç•™ç­–ç•¥
#   - å¥åº·æ£€æŸ¥å’Œç›‘æ§
#   - æœ¬åœ°å¤‡ä»½å­˜å‚¨
#
# ä½¿ç”¨æ–¹æ³•:
#   docker-compose -f docker-compose.backup.yml up -d
#
# é…ç½®ç¯å¢ƒå˜é‡åœ¨ .env.backup æ–‡ä»¶ä¸­
################################################################################

services:
  # PostgreSQL è‡ªåŠ¨åŒ–å¤‡ä»½æœåŠ¡
  postgres-backup:
    image: prodrigestivill/postgres-backup-local:16
    container_name: postgres_backup
    restart: unless-stopped

    volumes:
      # å¤‡ä»½å­˜å‚¨ä½ç½®ï¼ˆå®¹å™¨å¤–éƒ¨ï¼Œç¡®ä¿æ•°æ®å®‰å…¨ï¼‰
      - ./backups/auto:/backups

    environment:
      # æ•°æ®åº“è¿æ¥é…ç½®
      POSTGRES_HOST: ${DB_HOST:-postgres}
      POSTGRES_PORT: ${DB_PORT:-5432}
      POSTGRES_DB: ${DB_NAME:-tdp}
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD}

      # å¤‡ä»½é…ç½®
      POSTGRES_EXTRA_OPTS: >-
        --format=custom
        --compress=9
        --schema=public
        --blobs
        --no-owner
        --no-acl

      # å¤‡ä»½æ—¶é—´è¡¨ (Cron æ ¼å¼)
      # é»˜è®¤: æ¯å¤©å‡Œæ™¨ 2:00 AM
      # æ ¼å¼: "åˆ† æ—¶ æ—¥ æœˆ å‘¨"
      SCHEDULE: ${BACKUP_SCHEDULE:-@daily}
      # æ›¿ä»£é…ç½®ç¤ºä¾‹:
      # - "0 2 * * *"      æ¯å¤©å‡Œæ™¨2ç‚¹
      # - "@hourly"         æ¯å°æ—¶
      # - "0 */6 * * *"    æ¯6å°æ—¶

      # å¤‡ä»½ä¿ç•™ç­–ç•¥
      BACKUP_KEEP_DAYS: ${BACKUP_KEEP_DAYS:-7} # ä¿ç•™7å¤©çš„æ¯æ—¥å¤‡ä»½
      BACKUP_KEEP_WEEKS: ${BACKUP_KEEP_WEEKS:-4} # ä¿ç•™4å‘¨çš„æ¯å‘¨å¤‡ä»½
      BACKUP_KEEP_MONTHS: ${BACKUP_KEEP_MONTHS:-6} # ä¿ç•™6ä¸ªæœˆçš„æ¯æœˆå¤‡ä»½

      # å¤‡ä»½æ–‡ä»¶å‘½å
      # æ ¼å¼: {database}_{timestamp}.sql.gz
      BACKUP_SUFFIX: .dump

      # å¥åº·æ£€æŸ¥ç«¯å£
      HEALTHCHECK_PORT: 8080

      # æ—¶åŒºè®¾ç½®
      TZ: Asia/Shanghai

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

    labels:
      - "com.tdp.service=backup"
      - "com.tdp.description=Automated PostgreSQL backup service"

    # ç½‘ç»œé…ç½®
    # å¦‚æœ PostgreSQL åœ¨åŒä¸€ docker-compose ä¸­ï¼Œä½¿ç”¨ç›¸åŒç½‘ç»œ
    # networks:
    #   - backend

    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M

  # å¦‚æœéœ€è¦ï¼Œå®šä¹‰å…±äº«ç½‘ç»œ
  # networks:
  #   backend:
  #     external: true
  #     name: tdp_backend

  ################################################################################
  # å¤‡ä»½éªŒè¯æœåŠ¡ (å¯é€‰)
  #
  # å®šæœŸéªŒè¯å¤‡ä»½å®Œæ•´æ€§
  ################################################################################
  backup-verifier:
    image: postgres:16-alpine
    container_name: backup_verifier
    restart: "no" # ä»…æ‰‹åŠ¨è¿è¡Œæˆ–é€šè¿‡ cron è§¦å‘

    volumes:
      - ./backups/auto:/backups:ro
      - ./scripts/backup/verify-backup.sh:/scripts/verify-backup.sh:ro

    environment:
      PGHOST: ${DB_HOST:-postgres}
      PGPORT: ${DB_PORT:-5432}
      PGUSER: ${DB_USER:-postgres}
      PGPASSWORD: ${DB_PASSWORD}

    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "ğŸ” å¤‡ä»½éªŒè¯æœåŠ¡å·²å‡†å¤‡å°±ç»ª"
        echo "æ‰‹åŠ¨è¿è¡ŒéªŒè¯: docker-compose -f docker-compose.backup.yml run backup-verifier /scripts/verify-backup.sh /backups/latest.dump"
        sleep infinity

    profiles:
      - tools # ä»…åœ¨ç‰¹å®š profile ä¸‹è¿è¡Œ

################################################################################
# ä½¿ç”¨è¯´æ˜
################################################################################
#
# 1. åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶ .env.backup:
#    cp .env.backup.example .env.backup
#    ç¼–è¾‘å¹¶å¡«å†™æ•°æ®åº“è¿æ¥ä¿¡æ¯
#
# 2. å¯åŠ¨å¤‡ä»½æœåŠ¡:
#    docker-compose -f docker-compose.backup.yml up -d
#
# 3. æŸ¥çœ‹å¤‡ä»½æ—¥å¿—:
#    docker-compose -f docker-compose.backup.yml logs -f postgres-backup
#
# 4. æ‰‹åŠ¨è§¦å‘å¤‡ä»½:
#    docker-compose -f docker-compose.backup.yml exec postgres-backup backup
#
# 5. éªŒè¯å¤‡ä»½:
#    docker-compose -f docker-compose.backup.yml run backup-verifier /scripts/verify-backup.sh /backups/latest.dump
#
# 6. æŸ¥çœ‹å¤‡ä»½æ–‡ä»¶:
#    ls -lh ./backups/auto/
#
# 7. åœæ­¢å¤‡ä»½æœåŠ¡:
#    docker-compose -f docker-compose.backup.yml down
#
################################################################################
