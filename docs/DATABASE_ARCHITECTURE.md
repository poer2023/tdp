# æ•°æ®åº“æ¶æ„æ–‡æ¡£

> **æœ€åæ›´æ–°**: 2025-01-08
> **ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### ç¯å¢ƒé…ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TDP æ•°æ®åº“æ¶æ„                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¼€å‘æ•°æ®åº“ (DEV)    â”‚         â”‚  ç”Ÿäº§æ•°æ®åº“ (PROD)    â”‚
â”‚                      â”‚         â”‚                      â”‚
â”‚ ğŸ“ VPS ç‹¬ç«‹éƒ¨ç½²      â”‚         â”‚ ğŸ³ Docker å®¹å™¨åŒ–     â”‚
â”‚ ğŸŒ 38.246.246.229   â”‚         â”‚ ğŸ”’ ç”Ÿäº§ç¯å¢ƒéš”ç¦»      â”‚
â”‚ ğŸ”Œ Port: 5432       â”‚         â”‚ ğŸ“¦ ä¸åº”ç”¨å®¹å™¨å…±äº«ç½‘ç»œ â”‚
â”‚ ğŸ’¾ æ•°æ®åº“å: tdp     â”‚         â”‚ ğŸ’¾ æ•°æ®åº“å: [PROD]  â”‚
â”‚                      â”‚         â”‚                      â”‚
â”‚ ç”¨é€”:                â”‚         â”‚ ç”¨é€”:                â”‚
â”‚ â€¢ æ—¥å¸¸å¼€å‘           â”‚         â”‚ â€¢ ç”Ÿäº§ç¯å¢ƒ           â”‚
â”‚ â€¢ åŠŸèƒ½æµ‹è¯•           â”‚         â”‚ â€¢ çœŸå®ç”¨æˆ·æ•°æ®       â”‚
â”‚ â€¢ é›†æˆæµ‹è¯•           â”‚         â”‚ â€¢ 24/7 è¿è¡Œ         â”‚
â”‚ â€¢ è¿ç§»æµ‹è¯•           â”‚         â”‚ â€¢ è‡ªåŠ¨å¤‡ä»½           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš ï¸ é‡è¦è§„åˆ™

### ğŸ”´ ä¸¥æ ¼ç¦æ­¢çš„æ“ä½œ

1. **ç¦æ­¢åœ¨ç”Ÿäº§æ•°æ®åº“è¿è¡Œæµ‹è¯•**
   - é›†æˆæµ‹è¯•ä¼šè°ƒç”¨ `cleanDatabase()` æ¸…ç©ºæ‰€æœ‰è¡¨
   - å¿…é¡»ä½¿ç”¨ç‹¬ç«‹çš„æµ‹è¯•æ•°æ®åº“
   - ç¯å¢ƒå˜é‡å¿…é¡»åŒ…å« `test` å…³é”®å­—

2. **ç¦æ­¢ç›´æ¥åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œè¿ç§»**
   - å¿…é¡»å…ˆåœ¨å¼€å‘/æµ‹è¯•ç¯å¢ƒéªŒè¯
   - å¿…é¡»å…ˆå¤‡ä»½ç”Ÿäº§æ•°æ®åº“
   - å¿…é¡»éªŒè¯å¤‡ä»½å¯æ¢å¤

3. **ç¦æ­¢è·³è¿‡å¤‡ä»½éªŒè¯**
   - æ¯æ¬¡è¿ç§»å‰å¿…é¡»åˆ›å»ºå¤‡ä»½
   - å¤‡ä»½å¿…é¡»é€šè¿‡éªŒè¯æµ‹è¯•
   - ä¿ç•™è‡³å°‘æœ€è¿‘7å¤©çš„å¤‡ä»½

---

## ğŸ“‹ ç¯å¢ƒå˜é‡é…ç½®

### å¼€å‘ç¯å¢ƒ (`.env.development`)

```env
# å¼€å‘æ•°æ®åº“ - VPS éƒ¨ç½²
DATABASE_URL="postgresql://xin:sQy255izzBx7ezXh@38.246.246.229:5432/tdp?schema=public&connection_limit=10&pool_timeout=20&connect_timeout=10&socket_timeout=20"

NODE_ENV=development
```

### æµ‹è¯•ç¯å¢ƒ (`.env.test`)

```env
# æµ‹è¯•æ•°æ®åº“ - å¿…é¡»ä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“
DATABASE_URL="postgresql://user:password@localhost:5432/tdp_test?schema=public"
TEST_DATABASE_URL="postgresql://user:password@localhost:5432/tdp_test?schema=public"

NODE_ENV=test
```

### ç”Ÿäº§ç¯å¢ƒ (`.env.production`)

```env
# ç”Ÿäº§æ•°æ®åº“ - Docker å®¹å™¨å†…
DATABASE_URL="postgresql://user:password@postgres:5432/tdp_production?schema=public"

NODE_ENV=production
```

---

## ğŸ”’ æ•°æ®åº“å®‰å…¨ç­–ç•¥

### è®¿é—®æ§åˆ¶

| ç¯å¢ƒ     | è®¿é—®æƒé™         | å¤‡ä»½ç­–ç•¥            | ç›‘æ§     |
| -------- | ---------------- | ------------------- | -------- |
| **å¼€å‘** | å¼€å‘å›¢é˜Ÿå…¨å‘˜     | æ¯å‘¨å¤‡ä»½            | åŸºç¡€ç›‘æ§ |
| **æµ‹è¯•** | CI/CD + å¼€å‘å›¢é˜Ÿ | æŒ‰éœ€å¤‡ä»½            | é”™è¯¯æ—¥å¿— |
| **ç”Ÿäº§** | ä»…è¿ç»´äººå‘˜       | **æ¯æ—¥å¤‡ä»½** + éªŒè¯ | å…¨é¢ç›‘æ§ |

### å¤‡ä»½ç­–ç•¥

#### ç”Ÿäº§ç¯å¢ƒå¤‡ä»½

```bash
# å¤‡ä»½é¢‘ç‡
- æ¯æ—¥è‡ªåŠ¨å¤‡ä»½: å‡Œæ™¨ 2:00 AM
- è¿ç§»å‰æ‰‹åŠ¨å¤‡ä»½: å¿…é¡»

# ä¿ç•™ç­–ç•¥
- æ¯æ—¥å¤‡ä»½: ä¿ç•™ 7 å¤©
- æ¯å‘¨å¤‡ä»½: ä¿ç•™ 4 å‘¨
- æ¯æœˆå¤‡ä»½: ä¿ç•™ 6 ä¸ªæœˆ

# å­˜å‚¨ä½ç½®
- æœ¬åœ°: /var/backups/postgres/
- è¿œç¨‹: [é…ç½®äº‘å­˜å‚¨æœåŠ¡]
```

#### å¼€å‘ç¯å¢ƒå¤‡ä»½

```bash
# å¤‡ä»½é¢‘ç‡
- æ¯å‘¨è‡ªåŠ¨å¤‡ä»½: å‘¨æ—¥å‡Œæ™¨
- é‡è¦èŠ‚ç‚¹æ‰‹åŠ¨å¤‡ä»½: ç‰ˆæœ¬å‘å¸ƒå‰

# ä¿ç•™ç­–ç•¥
- æ¯å‘¨å¤‡ä»½: ä¿ç•™ 2 å‘¨
```

---

## ğŸš€ è¿ç§»æµç¨‹

### æ ‡å‡†è¿ç§»æµç¨‹

```mermaid
graph TD
    A[åˆ›å»ºè¿ç§»] -->|npx prisma migrate dev| B[å¼€å‘ç¯å¢ƒæµ‹è¯•]
    B --> C{æµ‹è¯•é€šè¿‡?}
    C -->|å¦| A
    C -->|æ˜¯| D[å¤‡ä»½ç”Ÿäº§æ•°æ®åº“]
    D --> E[éªŒè¯å¤‡ä»½å®Œæ•´æ€§]
    E --> F{éªŒè¯é€šè¿‡?}
    F -->|å¦| D
    F -->|æ˜¯| G[æ‰§è¡Œç”Ÿäº§è¿ç§»]
    G --> H[æ•°æ®å®Œæ•´æ€§éªŒè¯]
    H --> I{éªŒè¯é€šè¿‡?}
    I -->|å¦| J[ä»å¤‡ä»½æ¢å¤]
    I -->|æ˜¯| K[è¿ç§»å®Œæˆ]
```

### è¿ç§»æ£€æŸ¥æ¸…å•

#### âœ… è¿ç§»å‰æ£€æŸ¥

- [ ] è¿ç§»å·²åœ¨å¼€å‘ç¯å¢ƒæµ‹è¯•
- [ ] è¿ç§»å·²åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
- [ ] ç”Ÿäº§æ•°æ®åº“å¤‡ä»½å®Œæˆ
- [ ] å¤‡ä»½å·²é€šè¿‡éªŒè¯æµ‹è¯•
- [ ] ç£ç›˜ç©ºé—´å……è¶³ (>3x æ•°æ®åº“å¤§å°)
- [ ] å›æ»šè„šæœ¬å·²å‡†å¤‡
- [ ] ç»´æŠ¤çª—å£å·²é€šçŸ¥ï¼ˆå¦‚éœ€è¦ï¼‰

#### âœ… è¿ç§»åéªŒè¯

- [ ] è¿ç§»æˆåŠŸå®Œæˆ
- [ ] åº”ç”¨å¯åŠ¨æ— é”™è¯¯
- [ ] æ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡
- [ ] å…³é”®æŸ¥è¯¢æ€§èƒ½æ­£å¸¸
- [ ] æ— é”™è¯¯æ—¥å¿—æ¿€å¢
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] è¿ç§»åå¤‡ä»½å·²åˆ›å»º

---

## ğŸ“Š æ•°æ®åº“ç›‘æ§

### å…³é”®æŒ‡æ ‡

```typescript
// éœ€è¦ç›‘æ§çš„æŒ‡æ ‡
const monitoringMetrics = {
  // è¿æ¥ç›‘æ§
  activeConnections: "SELECT count(*) FROM pg_stat_activity",
  maxConnections: "SHOW max_connections",

  // æ€§èƒ½ç›‘æ§
  databaseSize: "SELECT pg_size_pretty(pg_database_size(current_database()))",
  tableRowCounts: "SELECT relname, n_live_tup FROM pg_stat_user_tables",

  // å¥åº·æ£€æŸ¥
  checksumFailures: "SELECT sum(checksum_failures) FROM pg_stat_database",
  replicationLag: "SELECT pg_last_xact_replay_timestamp()", // å¦‚æœæœ‰ä¸»ä»

  // å¤‡ä»½ç›‘æ§
  lastBackupAge: "ls -lt /backups/ | head -2",
  backupSize: "du -sh /backups/latest.dump",
};
```

### å‘Šè­¦é˜ˆå€¼

| æŒ‡æ ‡     | è­¦å‘Šé˜ˆå€¼ | ä¸¥é‡é˜ˆå€¼ | æ“ä½œ            |
| -------- | -------- | -------- | --------------- |
| è¿æ¥æ•°   | >70%     | >90%     | æ‰©å®¹/ä¼˜åŒ–è¿æ¥æ±  |
| ç£ç›˜ä½¿ç”¨ | >70%     | >85%     | æ¸…ç†/æ‰©å®¹       |
| å¤‡ä»½å¹´é¾„ | >36å°æ—¶  | >48å°æ—¶  | æ‰‹åŠ¨è§¦å‘å¤‡ä»½    |
| æŸ¥è¯¢å»¶è¿Ÿ | >1s      | >3s      | æ€§èƒ½åˆ†æ        |

---

## ğŸ› ï¸ å¸¸ç”¨æ“ä½œå‘½ä»¤

### å¤‡ä»½æ“ä½œ

```bash
# æ‰‹åŠ¨åˆ›å»ºå¤‡ä»½
./scripts/backup/create-backup.sh

# éªŒè¯å¤‡ä»½å®Œæ•´æ€§
./scripts/backup/verify-backup.sh /path/to/backup.dump

# æ¢å¤å¤‡ä»½
./scripts/backup/restore-backup.sh /path/to/backup.dump
```

### è¿ç§»æ“ä½œ

```bash
# æŸ¥çœ‹è¿ç§»çŠ¶æ€
npx prisma migrate status

# éƒ¨ç½²è¿ç§»ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
./scripts/migration/deploy-migration.sh

# éªŒè¯è¿ç§»ç»“æœ
npm run validate:migration
```

### å¥åº·æ£€æŸ¥

```bash
# æ•°æ®åº“å¥åº·æ£€æŸ¥
./scripts/monitoring/database-health.sh

# æ£€æŸ¥å¤‡ä»½çŠ¶æ€
./scripts/monitoring/check-backup-status.sh
```

---

## ğŸ”§ æ•…éšœå¤„ç†

### å¸¸è§é—®é¢˜

#### é—®é¢˜ 1: è¿ç§»å¤±è´¥

```bash
# 1. æ£€æŸ¥é”™è¯¯æ—¥å¿—
docker logs postgres_container --tail 100

# 2. æŸ¥çœ‹è¿ç§»çŠ¶æ€
npx prisma migrate status

# 3. å¦‚æœè¿ç§»éƒ¨åˆ†å®Œæˆ
npx prisma migrate resolve --rolled-back migration_name

# 4. æ¢å¤å¤‡ä»½ï¼ˆå¦‚æœéœ€è¦ï¼‰
./scripts/backup/restore-backup.sh latest
```

#### é—®é¢˜ 2: æ•°æ®ä¸¢å¤±

```bash
# 1. ç«‹å³åœæ­¢åº”ç”¨
docker-compose stop app

# 2. åˆ›å»ºå½“å‰çŠ¶æ€å¿«ç…§
./scripts/backup/create-backup.sh emergency

# 3. ä»æœ€è¿‘å¤‡ä»½æ¢å¤
./scripts/backup/restore-backup.sh latest

# 4. éªŒè¯æ•°æ®å®Œæ•´æ€§
npm run validate:data
```

#### é—®é¢˜ 3: è¿æ¥è¶…æ—¶

```bash
# 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | grep postgres

# 2. æ£€æŸ¥ç½‘ç»œè¿æ¥
docker exec postgres_container pg_isready

# 3. æŸ¥çœ‹æ´»åŠ¨è¿æ¥
docker exec postgres_container psql -U postgres -c "
  SELECT count(*), state FROM pg_stat_activity GROUP BY state;
"

# 4. é‡å¯æ•°æ®åº“ï¼ˆæœ€åæ‰‹æ®µï¼‰
docker-compose restart postgres
```

---

## ğŸ“ ç»´æŠ¤è®°å½•

### è¿ç§»å†å²

| æ—¥æœŸ       | è¿ç§»                                  | æè¿°               | æ‰§è¡Œäºº | çŠ¶æ€    |
| ---------- | ------------------------------------- | ------------------ | ------ | ------- |
| 2025-01-08 | 20251028193000_align_sync_schema      | ä¿®å¤ enum è¿ç§»é—®é¢˜ | Claude | âœ… æˆåŠŸ |
| 2025-01-08 | 20251106213128_add_friend_cover_field | æ·»åŠ æœ‹å‹å°é¢å­—æ®µ   | Claude | âœ… æˆåŠŸ |

### é‡å¤§äº‹ä»¶

| æ—¥æœŸ       | äº‹ä»¶                   | å½±å“     | å¤„ç†æ–¹å¼             | æ•™è®­                                                              |
| ---------- | ---------------------- | -------- | -------------------- | ----------------------------------------------------------------- |
| 2025-01-08 | é›†æˆæµ‹è¯•æ¸…ç©ºå¼€å‘æ•°æ®åº“ | æ•°æ®ä¸¢å¤± | æ— å¤‡ä»½ï¼Œæ•°æ®æ— æ³•æ¢å¤ | 1. å¿…é¡»éš”ç¦»æµ‹è¯•æ•°æ®åº“<br>2. å¿…é¡»å®šæœŸå¤‡ä»½<br>3. æ·»åŠ æ•°æ®åº“ä¿æŠ¤æœºåˆ¶ |

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [å¤‡ä»½ç­–ç•¥è¯¦ç»†æ–‡æ¡£](./BACKUP_STRATEGY.md)
- [è¿ç§»æµç¨‹è¯¦ç»†æŒ‡å—](./MIGRATION_GUIDE.md)
- [æ•…éšœæ¢å¤æ‰‹å†Œ](./DISASTER_RECOVERY.md)
- [æ€§èƒ½ä¼˜åŒ–æŒ‡å—](./PERFORMANCE_TUNING.md)

---

## ğŸ“ è”ç³»æ–¹å¼

### ç´§æ€¥è”ç³»

- **æ•°æ®åº“é—®é¢˜**: [è¿ç»´å›¢é˜Ÿ]
- **è¿ç§»é—®é¢˜**: [å¼€å‘å›¢é˜Ÿ]
- **å¤‡ä»½æ¢å¤**: [è¿ç»´å›¢é˜Ÿ]

### èµ„æºé“¾æ¥

- PostgreSQL å®˜æ–¹æ–‡æ¡£: https://www.postgresql.org/docs/
- Prisma è¿ç§»æ–‡æ¡£: https://www.prisma.io/docs/concepts/components/prisma-migrate
- Docker PostgreSQL æœ€ä½³å®è·µ: https://docs.docker.com/samples/library/postgres/

---

**ğŸ”’ æœ¬æ–‡æ¡£åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œè¯·å‹¿å…¬å¼€åˆ†äº«**
